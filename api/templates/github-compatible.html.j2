<svg width="480" height="133" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
        <!-- Sleek dark gradient background -->
        <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#0d1117;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#161b22;stop-opacity:1" />
        </linearGradient>
        
        <!-- Spotify green gradient -->
        <linearGradient id="spotifyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#1DB954;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#1ed760;stop-opacity:1" />
        </linearGradient>
        
        <!-- Album art shadow and glow -->
        <filter id="albumEffect" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="4"/>
            <feOffset dx="0" dy="2" result="offsetblur"/>
            <feComponentTransfer>
                <feFuncA type="linear" slope="0.4"/>
            </feComponentTransfer>
            <feColorMatrix type="matrix" values="0 0 0 0 {{ bar_palette[1][0]/255 }}
                                                   0 0 0 0 {{ bar_palette[1][1]/255 }}
                                                   0 0 0 0 {{ bar_palette[1][2]/255 }}
                                                   0 0 0 0.3 0"/>
            <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        
        <!-- Subtle bar glow -->
        <filter id="barGlow">
            <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
            <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        
        <!-- Text shadow for depth -->
        <filter id="textShadow">
            <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.4"/>
        </filter>
        
        <!-- Clip for album art -->
        <clipPath id="albumClip">
            <rect x="18" y="18" width="97" height="97" rx="10"/>
        </clipPath>
        
        <!-- Gradient for text -->
        <linearGradient id="textGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#e6e6e6;stop-opacity:1" />
        </linearGradient>
    </defs>
    
    <!-- Background card -->
    <rect width="480" height="133" rx="10" fill="url(#bgGrad)"/>
    
    <!-- Subtle inner border -->
    <rect x="1" y="1" width="478" height="131" rx="9" fill="none" stroke="#21262d" stroke-width="1" opacity="0.5"/>
    
    <!-- Playing state accent -->
    {% if is_playing %}
    <rect x="0" y="0" width="480" height="133" rx="10" fill="none" stroke="url(#spotifyGrad)" stroke-width="2">
        <animate attributeName="opacity" values="0.4;0.7;0.4" dur="3s" repeatCount="indefinite"/>
    </rect>
    <rect x="18" y="18" width="4" height="97" rx="2" fill="url(#spotifyGrad)">
        <animate attributeName="opacity" values="0.8;1;0.8" dur="2s" repeatCount="indefinite"/>
    </rect>
    {% else %}
    <rect x="0" y="0" width="480" height="133" rx="10" fill="none" stroke="#30363d" stroke-width="1.5"/>
    {% endif %}
    
    <!-- Album art with effects -->
    <g filter="url(#albumEffect)">
        <rect x="18" y="18" width="97" height="97" rx="10" fill="#000" opacity="0.2"/>
    </g>
    <image x="18" y="18" width="97" height="97" href="data:image/png;base64,{{ image }}" 
           preserveAspectRatio="xMidYMid slice" clip-path="url(#albumClip)">
        <animate attributeName="opacity" values="0;1" dur="0.6s" fill="freeze"/>
    </image>
    
    <!-- Content area -->
    <g transform="translate(133, 0)">
        
        <!-- Status indicator -->
        {% if is_playing %}
        <g transform="translate(0, 24)">
            <rect x="0" y="-10" width="100" height="20" rx="10" fill="#1DB954" opacity="0.12"/>
            <circle cx="10" cy="0" r="3.5" fill="#1DB954">
                <animate attributeName="opacity" values="1;0.5;1" dur="1.5s" repeatCount="indefinite"/>
            </circle>
            <text x="20" y="5" font-family="'SF Pro Display','Segoe UI',system-ui,-apple-system,sans-serif" 
                  font-size="12" font-weight="700" fill="#1DB954" letter-spacing="1">
                NOW PLAYING
            </text>
        </g>
        {% else %}
        <g transform="translate(0, 24)">
            <rect x="0" y="-10" width="115" height="20" rx="10" fill="#58a6ff" opacity="0.08"/>
            <circle cx="10" cy="0" r="3" fill="#58a6ff" opacity="0.6"/>
            <text x="20" y="5" font-family="'SF Pro Display','Segoe UI',system-ui,-apple-system,sans-serif" 
                  font-size="12" font-weight="600" fill="#58a6ff" letter-spacing="1" opacity="0.8">
                RECENTLY PLAYED
            </text>
        </g>
        {% endif %}
        
        <!-- Track title -->
        <text x="0" y="58" font-family="'SF Pro Display','Segoe UI',system-ui,-apple-system,sans-serif" 
              font-size="20" font-weight="800" fill="url(#textGrad)" letter-spacing="-0.3"
              filter="url(#textShadow)">
            {{ song_name[:29] }}{% if song_name|length > 29 %}...{% endif %}
        </text>
        
        <!-- Artist name with icon -->
        <g transform="translate(0, 83)">
            <!-- Microphone icon -->
            <g transform="translate(0, -9) scale(0.7)">
                <circle cx="6" cy="5" r="3" fill="none" stroke="#8b949e" stroke-width="1.5" opacity="0.6"/>
                <line x1="6" y1="8" x2="6" y2="12" stroke="#8b949e" stroke-width="1.5" opacity="0.6"/>
                <path d="M3,10 Q3,12 6,12 Q9,12 9,10" fill="none" stroke="#8b949e" stroke-width="1.5" opacity="0.6"/>
            </g>
            <text x="18" y="0" font-family="'SF Pro Display','Segoe UI',system-ui,-apple-system,sans-serif" 
                  font-size="15" font-weight="500" fill="#8b949e" letter-spacing="-0.2">
                {{ artist_name[:33] }}{% if artist_name|length > 33 %}...{% endif %}
            </text>
        </g>
        
        <!-- Equalizer visualization -->
        <g transform="translate(0, 102)">
            {% for i in range(14) %}
            <g transform="translate({{ i * 8.5 }}, 0)">
                <!-- Bar track -->
                <rect x="0" y="0" width="4.5" height="16" rx="2.25" fill="#21262d" opacity="0.4"/>
                <!-- Animated bar -->
                <rect x="0" y="0" width="4.5" height="16" rx="2.25" 
                      fill="rgb({{ bar_palette[i % 4][0] }}, {{ bar_palette[i % 4][1] }}, {{ bar_palette[i % 4][2] }})" 
                      filter="url(#barGlow)">
                    <animate attributeName="height" 
                             values="2;{{ 8 + (i % 4) * 2 }};3;{{ 12 + (i % 3) * 2 }};2" 
                             dur="{{ 320 + (i * 38) }}ms" 
                             repeatCount="indefinite"/>
                    <animate attributeName="y" 
                             values="14;{{ 8 - (i % 4) * 2 }};13;{{ 4 - (i % 3) * 2 }};14" 
                             dur="{{ 320 + (i * 38) }}ms" 
                             repeatCount="indefinite"/>
                    <animate attributeName="opacity" 
                             values="0.65;0.95;0.7;1;0.65" 
                             dur="{{ 320 + (i * 38) }}ms" 
                             repeatCount="indefinite"/>
                </rect>
            </g>
            {% endfor %}
        </g>
        
    </g>
    
    <!-- Spotify branding -->
    <g transform="translate(455, 20)">
        <circle cx="0" cy="0" r="16" fill="#000" opacity="0.05"/>
        <circle cx="0" cy="0" r="13" fill="#1DB954" opacity="0.12"/>
        <g transform="scale(0.65)" opacity="0.85">
            <circle cx="0" cy="0" r="11" fill="none" stroke="#1DB954" stroke-width="1.5"/>
            <path d="M-7,-3.5 Q0,-7 7,-3.5 M-7,-0.5 Q0,-3.5 7,-0.5 M-7,2.5 Q0,0.5 7,2.5" 
                  stroke="#1DB954" stroke-width="2.2" stroke-linecap="round" fill="none"/>
        </g>
    </g>
    
    <!-- Subtle bottom decoration -->
    <line x1="133" y1="125" x2="470" y2="125" stroke="#21262d" stroke-width="1" opacity="0.3"/>
    
</svg>
