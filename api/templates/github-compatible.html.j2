<svg width="480" height="133" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
        <!-- Modern gradient background -->
        <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#0d1117;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#161b22;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#0d1117;stop-opacity:1" />
        </linearGradient>
        
        <!-- Spotify gradient -->
        <linearGradient id="spotifyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#1ed760;stop-opacity:1">
                <animate attributeName="stop-opacity" values="1;0.8;1" dur="2s" repeatCount="indefinite"/>
            </stop>
            <stop offset="100%" style="stop-color:#1DB954;stop-opacity:1">
                <animate attributeName="stop-opacity" values="1;0.9;1" dur="2s" repeatCount="indefinite"/>
            </stop>
        </linearGradient>
        
        <!-- Blue gradient for recently played -->
        <linearGradient id="blueGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#58a6ff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#388bfd;stop-opacity:1" />
        </linearGradient>
        
        <!-- Premium album shadow -->
        <filter id="albumShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="6"/>
            <feOffset dx="0" dy="3" result="offsetblur"/>
            <feComponentTransfer>
                <feFuncA type="linear" slope="0.35"/>
            </feComponentTransfer>
            <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        
        <!-- Bar glow effect -->
        <filter id="barGlow">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feFlood flood-color="rgb({{ bar_palette[1][0] }}, {{ bar_palette[1][1] }}, {{ bar_palette[1][2] }})" result="color"/>
            <feComposite in="color" in2="blur" operator="in" result="glow"/>
            <feMerge>
                <feMergeNode in="glow"/>
                <feMergeNode in="SourceGraphic"/>
            </feMerge>
        </filter>
        
        <!-- Text shadow -->
        <filter id="textShadow">
            <feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-color="#000" flood-opacity="0.5"/>
        </filter>
        
        <!-- Album clip path -->
        <clipPath id="albumClip">
            <rect x="16" y="16" width="101" height="101" rx="12"/>
        </clipPath>
    </defs>
    
    <!-- Background -->
    <rect width="480" height="133" rx="11" fill="url(#bgGrad)"/>
    
    <!-- Outer glow border -->
    {% if is_playing %}
    <rect x="0.5" y="0.5" width="479" height="132" rx="10.5" fill="none" stroke="url(#spotifyGrad)" stroke-width="2.5" opacity="0.6">
        <animate attributeName="stroke-width" values="2.5;3;2.5" dur="2s" repeatCount="indefinite"/>
    </rect>
    {% else %}
    <rect x="0.5" y="0.5" width="479" height="132" rx="10.5" fill="none" stroke="#30363d" stroke-width="2"/>
    {% endif %}
    
    <!-- Inner border accent -->
    <rect x="2" y="2" width="476" height="129" rx="9" fill="none" stroke="#21262d" stroke-width="1" opacity="0.4"/>
    
    <!-- Album art with premium shadow -->
    <g filter="url(#albumShadow)">
        <image x="16" y="16" width="101" height="101" href="data:image/png;base64,{{ image }}" 
               preserveAspectRatio="xMidYMid slice" clip-path="url(#albumClip)">
            <animate attributeName="opacity" values="0;1" dur="0.5s" fill="freeze"/>
        </image>
    </g>
    
    <!-- Subtle accent line next to album -->
    {% if is_playing %}
    <rect x="125" y="26" width="3" height="81" rx="1.5" fill="url(#spotifyGrad)">
        <animate attributeName="height" values="81;91;81" dur="3s" repeatCount="indefinite"/>
        <animate attributeName="y" values="26;21;26" dur="3s" repeatCount="indefinite"/>
    </rect>
    {% endif %}
    
    <!-- Content area -->
    <g transform="translate(140, 0)">
        
        <!-- Status badge - redesigned -->
        {% if is_playing %}
        <g transform="translate(0, 22)">
            <!-- Background with gradient -->
            <defs>
                <linearGradient id="badgeBg" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#1DB954;stop-opacity:0.15" />
                    <stop offset="100%" style="stop-color:#1ed760;stop-opacity:0.15" />
                </linearGradient>
            </defs>
            <rect x="-2" y="-12" width="108" height="24" rx="12" fill="url(#badgeBg)"/>
            <rect x="-2" y="-12" width="108" height="24" rx="12" fill="none" stroke="url(#spotifyGrad)" stroke-width="1.5" opacity="0.3"/>
            
            <!-- Animated pulse dot -->
            <circle cx="8" cy="0" r="4" fill="url(#spotifyGrad)">
                <animate attributeName="r" values="4;5;4" dur="1.5s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="1;0.7;1" dur="1.5s" repeatCount="indefinite"/>
            </circle>
            <circle cx="8" cy="0" r="6" fill="url(#spotifyGrad)" opacity="0.3">
                <animate attributeName="r" values="6;8;6" dur="1.5s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.3;0;0.3" dur="1.5s" repeatCount="indefinite"/>
            </circle>
            
            <text x="19" y="5.5" font-family="'Inter','SF Pro Display',system-ui,-apple-system,sans-serif" 
                  font-size="11" font-weight="800" fill="#1ed760" letter-spacing="1.2">
                NOW PLAYING
            </text>
        </g>
        {% else %}
        <g transform="translate(0, 22)">
            <rect x="-2" y="-12" width="128" height="24" rx="12" fill="#21262d" opacity="0.6"/>
            <rect x="-2" y="-12" width="128" height="24" rx="12" fill="none" stroke="url(#blueGrad)" stroke-width="1.5" opacity="0.2"/>
            
            <!-- Clock icon -->
            <g transform="translate(8, 0)">
                <circle cx="0" cy="0" r="5" fill="none" stroke="#58a6ff" stroke-width="1.5" opacity="0.7"/>
                <line x1="0" y1="0" x2="0" y2="-3" stroke="#58a6ff" stroke-width="1.5" opacity="0.7" stroke-linecap="round"/>
                <line x1="0" y1="0" x2="2" y2="0" stroke="#58a6ff" stroke-width="1.5" opacity="0.7" stroke-linecap="round"/>
            </g>
            
            <text x="19" y="5.5" font-family="'Inter','SF Pro Display',system-ui,-apple-system,sans-serif" 
                  font-size="11" font-weight="700" fill="#58a6ff" letter-spacing="1.1" opacity="0.85">
                RECENTLY PLAYED
            </text>
        </g>
        {% endif %}
        
        <!-- Track title - enhanced -->
        <text x="0" y="62" font-family="'Inter','SF Pro Display',system-ui,-apple-system,sans-serif" 
              font-size="21" font-weight="900" fill="#ffffff" letter-spacing="-0.5"
              filter="url(#textShadow)">
            {{ song_name[:27] }}{% if song_name|length > 27 %}...{% endif %}
        </text>
        
        <!-- Artist name - redesigned -->
        <g transform="translate(0, 87)">
            <!-- Artist icon -->
            <g transform="translate(0, -10) scale(0.8)">
                <circle cx="6" cy="6" r="5" fill="none" stroke="#8b949e" stroke-width="1.3" opacity="0.5"/>
                <circle cx="6" cy="4" r="2" fill="#8b949e" opacity="0.5"/>
                <path d="M2,9 Q2,7 6,7 Q10,7 10,9" fill="none" stroke="#8b949e" stroke-width="1.3" opacity="0.5"/>
            </g>
            <text x="18" y="0" font-family="'Inter','SF Pro Display',system-ui,-apple-system,sans-serif" 
                  font-size="15" font-weight="600" fill="#8b949e" letter-spacing="-0.3">
                {{ artist_name[:31] }}{% if artist_name|length > 31 %}...{% endif %}
            </text>
        </g>
        
        <!-- Enhanced equalizer bars -->
        <g transform="translate(0, 107)">
            {% for i in range(16) %}
            <g transform="translate({{ i * 7.5 }}, 0)">
                <!-- Bar container track -->
                <rect x="0" y="0" width="4.5" height="18" rx="2.25" fill="#21262d" opacity="0.5"/>
                
                <!-- Gradient for bar -->
                <defs>
                    <linearGradient id="barGrad{{ i }}" x1="0%" y1="100%" x2="0%" y2="0%">
                        <stop offset="0%" style="stop-color:rgb({{ bar_palette[i % 4][0] }}, {{ bar_palette[i % 4][1] }}, {{ bar_palette[i % 4][2] }});stop-opacity:0.7" />
                        <stop offset="100%" style="stop-color:rgb({{ bar_palette[(i+1) % 4][0] }}, {{ bar_palette[(i+1) % 4][1] }}, {{ bar_palette[(i+1) % 4][2] }});stop-opacity:1" />
                    </linearGradient>
                </defs>
                
                <!-- Animated bar with glow -->
                <rect x="0" y="0" width="4.5" height="18" rx="2.25" 
                      fill="url(#barGrad{{ i }})" filter="url(#barGlow)">
                    <!-- Height animation -->
                    <animate attributeName="height" 
                             values="2;{{ 7 + (i % 5) * 2.5 }};3;{{ 11 + (i % 4) * 2 }};2" 
                             dur="{{ 300 + (i * 32) }}ms" 
                             repeatCount="indefinite"/>
                    <!-- Y position animation -->
                    <animate attributeName="y" 
                             values="16;{{ 11 - (i % 5) * 2.5 }};15;{{ 7 - (i % 4) * 2 }};16" 
                             dur="{{ 300 + (i * 32) }}ms" 
                             repeatCount="indefinite"/>
                    <!-- Opacity pulse -->
                    <animate attributeName="opacity" 
                             values="0.6;1;0.7;1;0.6" 
                             dur="{{ 300 + (i * 32) }}ms" 
                             repeatCount="indefinite"/>
                </rect>
            </g>
            {% endfor %}
        </g>
        
    </g>
    
    <!-- Spotify logo - refined -->
    <g transform="translate(458, 18)">
        <circle cx="0" cy="0" r="17" fill="#1DB954" opacity="0.08"/>
        <circle cx="0" cy="0" r="14" fill="none" stroke="#1DB954" stroke-width="1.5" opacity="0.15"/>
        <g transform="scale(0.7)" opacity="0.9">
            <circle cx="0" cy="0" r="10" fill="none" stroke="#1DB954" stroke-width="1.8"/>
            <path d="M-6.5,-3 Q0,-6.5 6.5,-3" stroke="#1DB954" stroke-width="2" stroke-linecap="round" fill="none"/>
            <path d="M-6.5,0 Q0,-3 6.5,0" stroke="#1DB954" stroke-width="2" stroke-linecap="round" fill="none"/>
            <path d="M-6.5,3 Q0,0.5 6.5,3" stroke="#1DB954" stroke-width="2" stroke-linecap="round" fill="none"/>
        </g>
    </g>
    
</svg>
